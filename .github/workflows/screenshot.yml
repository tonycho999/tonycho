name: Auto X Marketing Bot

on:
  workflow_dispatch:       # 1. ìˆ˜ë™ ì‹¤í–‰ (ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì‹¤í–‰)
  schedule:
    # 2. ìë™ ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ 01:00 ~ 15:00 = í•„ë¦¬í•€ 09:00 ~ 23:00)
    # ë§¤ ì‹œê°„ 7ë¶„ì— ì‹¤í–‰
    - cron: '7 1-15 * * *'

jobs:
  post-tweet:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    # [ìˆ˜ì •ëœ ë¡œì§] í™•ë¥  ê³„ì‚° ë° ëŒ€ê¸° ì‹œê°„ ê²°ì •
    - name: Random Delay & Probability Check
      id: decision
      env:
        IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        node -e "
          const fs = require('fs');
          
          // 1. ìˆ˜ë™ ì‹¤í–‰ì´ë©´ ë¬´ì¡°ê±´ í†µê³¼ (ëŒ€ê¸° ì—†ìŒ)
          if (process.env.IS_MANUAL === 'true') {
            console.log('ğŸ”˜ ìˆ˜ë™ ì‹¤í–‰ ëª¨ë“œ: ì¦‰ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤.');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=true\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'sleep_time=0\n');
            process.exit(0);
          }

          // 2. í™•ë¥  ì²´í¬ (15%)
          const chance = Math.random() * 100;
          console.log('ğŸ² í™•ë¥  ì£¼ì‚¬ìœ„: ' + chance.toFixed(2) + '% (ëª©í‘œ: 15% ì´í•˜)');

          if (chance > 15) {
            console.log('ğŸ’¤ ê½! ì´ë²ˆ ì‹œê°„ì€ ì‰½ë‹ˆë‹¤.');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=false\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'sleep_time=0\n');
          } else {
            // 3. ë‹¹ì²¨ ì‹œ ëœë¤ ë”œë ˆì´ (0 ~ 25ë¶„ = 0 ~ 1500ì´ˆ)
            const maxDelaySeconds = 25 * 60; 
            const delaySeconds = Math.floor(Math.random() * maxDelaySeconds);
            
            console.log('ğŸ‰ ë‹¹ì²¨! ' + (delaySeconds / 60).toFixed(1) + 'ë¶„ (' + delaySeconds + 'ì´ˆ) ëŒ€ê¸° í›„ ì‹¤í–‰í•©ë‹ˆë‹¤.');
            
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=true\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'sleep_time=' + delaySeconds + '\n');
          }
        "

    # [ì¶”ê°€ë¨] ì‹¤ì œ ëŒ€ê¸° ìˆ˜í–‰ (ìš´ì˜ì²´ì œ ëª…ë ¹ì–´ ì‚¬ìš©ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ ë©ˆì¶¤)
    - name: Sleep for Random Delay
      if: steps.decision.outputs.should_run == 'true' && steps.decision.outputs.sleep_time != '0'
      run: sleep ${{ steps.decision.outputs.sleep_time }}

    # [ì‹¤í–‰ ë‹¨ê³„] ìœ„ ë‹¨ê³„ í†µê³¼ ì‹œ ì‹¤í–‰
    - name: Run X Bot
      if: steps.decision.outputs.should_run == 'true'
      env:
        # âš ï¸ [ì¤‘ìš” ìˆ˜ì •] ìŠ¤í¬ë¦°ìƒ·ì— ìˆëŠ” Secret ì´ë¦„ê³¼ ì •í™•íˆ ë§¤ì¹­í–ˆìŠµë‹ˆë‹¤.
        X_API_KEY: ${{ secrets.API_KEY }}
        X_API_SECRET: ${{ secrets.API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        # ìŠ¤í¬ë¦°ìƒ·ì— ACCESS_TOKEN_SECRET ì´ë¼ê³  ë˜ì–´ ìˆì–´ì„œ ê·¸ê²ƒìœ¼ë¡œ ì—°ê²°
        X_ACCESS_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }} 
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: node x-bot.js
