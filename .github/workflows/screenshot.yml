name: Auto X Marketing Bot

on:
  workflow_dispatch:       # 1. ìˆ˜ë™ ì‹¤í–‰ (ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì‹¤í–‰)
  schedule:
    # 2. ìë™ ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ 01:00 ~ 15:00 = í•„ë¦¬í•€ 09:00 ~ 23:00)
    # ë§¤ ì‹œê°„ 7ë¶„ì— ê¹¨ì–´ë‚©ë‹ˆë‹¤.
    - cron: '7 1-15 * * *'

jobs:
  post-tweet:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    # [í•µì‹¬ ë¡œì§] í™•ë¥  ê³„ì‚° ë° ëœë¤ ë”œë ˆì´
    - name: Random Delay & Probability Check
      id: decision
      env:
        IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        node -e "
          // 1. ìˆ˜ë™ ì‹¤í–‰ì´ë©´ ë¬´ì¡°ê±´ í†µê³¼ (ëŒ€ê¸° ì—†ìŒ)
          if (process.env.IS_MANUAL === 'true') {
            console.log('ğŸ”˜ ìˆ˜ë™ ì‹¤í–‰ ëª¨ë“œ: ì¦‰ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤.');
            const fs = require('fs');
            // GitHub Actionsì˜ ì¶œë ¥ ë³€ìˆ˜ ì„¤ì • (should_run=true)
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=true\n');
            process.exit(0);
          }

          // 2. í™•ë¥  ì²´í¬ (15%)
          // 15ì‹œê°„ ë™ì•ˆ ë§¤ì‹œê°„ ì‹¤í–‰ë˜ë¯€ë¡œ, 15 * 0.15 = í•˜ë£¨ í‰ê·  ì•½ 2.25íšŒ í¬ìŠ¤íŒ…
          const chance = Math.random() * 100;
          console.log('ğŸ² í™•ë¥  ì£¼ì‚¬ìœ„: ' + chance.toFixed(2) + '% (ëª©í‘œ: 15% ì´í•˜)');

          if (chance > 15) {
            console.log('ğŸ’¤ ê½! ì´ë²ˆ ì‹œê°„ì€ ì‰½ë‹ˆë‹¤.');
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=false\n');
            process.exit(0);
          }

          // 3. ë‹¹ì²¨ ì‹œ ëœë¤ ë”œë ˆì´ (0 ~ 25ë¶„, 100ms ë‹¨ìœ„ ì •ë°€ ì œì–´)
          const maxDelay = 25 * 60 * 1000; // 25ë¶„ (ë°€ë¦¬ì´ˆ)
          const delay = Math.floor(Math.random() * maxDelay); 
          // 100ms ë‹¨ìœ„ë¡œ ëŠê¸° ìœ„í•´ ë°˜ì˜¬ë¦¼ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­ì´ë‚˜ ìš”ì²­í•˜ì‹  ì •ë°€ë„ ë°˜ì˜)
          const preciseDelay = Math.floor(delay / 100) * 100;

          console.log('ğŸ‰ ë‹¹ì²¨! ' + (preciseDelay / 1000 / 60).toFixed(2) + 'ë¶„ ëŒ€ê¸° í›„ ê¸€ì„ ì˜¬ë¦½ë‹ˆë‹¤...');
          console.log('(ì •í™•í•œ ëŒ€ê¸° ì‹œê°„: ' + preciseDelay + 'ms)');

          const fs = require('fs');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_run=true\n');

          // Node.jsì˜ setTimeoutìœ¼ë¡œ ëŒ€ê¸°
          setTimeout(() => {
            console.log('â° ëŒ€ê¸° ì‹œê°„ ì¢…ë£Œ! ë´‡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.');
          }, preciseDelay);
        "

    # [ì‹¤í–‰ ë‹¨ê³„] ìœ„ ë‹¨ê³„ì—ì„œ should_runì´ trueì¼ ë•Œë§Œ ì‹¤í–‰ë¨
    - name: Run X Bot
      if: steps.decision.outputs.should_run == 'true'
      env:
        # Secrets ì„¤ì • (ì´ì „ ë‹¨ê³„ì—ì„œ ì„¤ì •í•œ í‚¤ë“¤)
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: node x-bot.js
